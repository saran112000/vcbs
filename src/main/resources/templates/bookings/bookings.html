<!DOCTYPE html>
<html lang="en">
<head>
	<meta name="_csrf" th:content="${_csrf.token}"/>
	<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/fontawesome/css/all.css}">
    <link rel="stylesheet" th:href="@{/fontfamily/css/google_font_family.css}">
    <link rel="stylesheet" th:href="@{/css/sidebar.css}">
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <script th:src="@{/js/script.js}"></script>
    
       
    <script th:src="@{/js/script.js}" defer></script>
  
    <script th:src="@{/bootstrap/js/jquery-3.7.1.js}"></script>

	<script th:src="@{/bootstrap/js/dataTables.js}"></script>
	
	<script th:src="@{/bootstrap/js/dataTables.bootstrap5.js}"></script>
	
	<script th:src="@{/bootstrap/js/bootstrap.bundle.min.js}"></script>
	
	<script th:src="@{/sweetalert/js/sweetalert2.all.min.js}"></script>
    
    <script th:inline="javascript">
    /* Defines a global variable for the context path */
    const contextPath = /*[[@{/}]]*/ '';
</script>
    

</head>
<body>



<div id="dashboardPage" class="page">
    <div class="dashboard-header">
            <div class="header-left">
                <div class="logo-mini">
                    <i class="fas fa-video"></i>
                    <span>VC Booking</span>
                </div>
                <h1>Welcome to Booking Page</h1>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <i class="fas fa-user-circle"></i>
                    <span id="loggedInUser">User</span>
                </div>
					              <a th:href="@{/login}" style="text-decoration: none;">
					    <button class="btn-logout" id="logoutBtn">
					        <i class="fas fa-sign-out-alt"></i> Logout
					    </button>
					</a>
            </div>
        </div>
        
        
        
				<div class="sidebar">
			    <ol class="menu" style="list-style: none; padding: 0;">
			        <li class="menu-item" th:each="main : ${mainModuleList}">
			            <span class="menu-title">
			                <i th:class="${main.moduleIcon}" style="margin-right: 10px;"></i>
			                <span th:text="${main.moduleName}">Main Menu</span>
			            </span>
			            
			            <ol class="submenu">
			                <th:block th:each="sub : ${subModuleList}">
			                    <li th:if="${sub.moduleId == main.moduleId}">
			                        <a th:href="@{${sub.moduleDetailsUrl}}" th:text="${sub.moduleDetailsName}">
			                            Sub Menu Item
			                        </a>
			                    </li>
			                </th:block>
			            </ol>
			        </li>
			    </ol>
			</div>
<!-- MAIN CONTENT -->
 <div class="content">

            <div class="content-section">

            
					       
					        
					    </div>

                <!-- ===== Room Selection ===== -->
                <div class="card">
                
                
 <form id="bookingForm" th:action="@{/booking/add}" th:object="${booking}" method="POST">

    <div class="card">
        <div class="form-row">

            <div class="input-group">
                <label style="color: white; font-weight: bold;">Room Type</label>
                <select name="roomTypeId" id="roomType" onchange="filterRoomsByType()">
   
    <option th:each="type : ${roomsType}"
            th:value="${type.roomTypeId}"
            th:text="${type.roomType}"
            th:selected="${type.roomTypeId == defaultRoomTypeId}">
    </option>
</select>
            </div>

            <div class="input-group">
                <label style="color: white; font-weight: bold;">Room No</label>
                <select name="roomId" id="roomNo" th:field="*{roomId}" onchange="loadBookedSlots()">
   
</select>
   

            </div>

            <div class="input-group">
                <label style="color: white; font-weight: bold;">Date</label>
<input type="date" id="bookingDate" th:field="*{bookingDate}" onchange="loadBookedSlots()">
       </div>

            <div class="input-group">
                <label style="color: white; font-weight: bold;">Employee Name</label>
                
               <select name="employeeId" id="employeeId" th:field="*{empID}">
   
    <option th:each="emp : ${employees}" 
            th:value="${emp.empId}" 
            th:text="${emp.empName}">
    </option>
</select>
                
            </div>

            <div class="input-group">
                <label style="color: white; font-weight: bold;">Guest</label>
                <input type="text" name="guest" id="guest" placeholder="Enter guest name" th:field="*{guest}">
            </div>

            <div class="input-group">
                <label style="color: white; font-weight: bold;">Subject</label>
                <input type="text" name="subject" id="subject" placeholder="Enter meeting subject"  th:field="*{subject}">
            </div>

        </div>
    </div>

    <!-- ===== Time Slots (MULTI SELECT) ===== -->
    <br>
    <div class="card">
        <h3 style="color: white; font-weight: bold;"><i class="fas fa-clock"></i> Time Slots</h3>
<br>
       <div class="time-slots">
    <label class="slot" th:each="time : ${availableSlots}">
        <input type="checkbox" th:field="*{Slot}" th:value="${time}" />
        <span th:text="${time}"></span>
    </label>
</div>
    </div>

    <div class="action-buttons">
        <button type="button" class="btn-book-slot" onclick="submitBookingForm()">
            <i class="fas fa-check-circle"></i> Book Slot
        </button>
    </div>

</form>
                  
                </div>
               

                

            </div>
        </div>
        

    </div>
   


    </div> 
    <script th:if="${successMessage}">Swal.fire("Success", "[[${successMessage}]]", "success");</script>
<script th:if="${errorMessage}">Swal.fire("Error", "[[${errorMessage}]]", "error");</script>
</body>
<script>
/* ================================
   GLOBAL VARIABLES
================================ */
let selectedSlotTime = null;




function submitBookingForm() {
    // 1. Get references to form elements
    const roomNo = document.getElementById("roomNo").value;
    const bookingDate = document.getElementById("bookingDate").value;
    const employeeId = document.getElementById("employeeId").value;
    const subject = document.getElementById("subject").value.trim();
    
    // 2. Validate Time Slots (Check if at least one checkbox is checked)
    const selectedSlots = document.querySelectorAll('input[name="Slot"]:checked');
    
    // 3. Validation Logic
    let errorMessage = "";

    if (!roomNo) {
        errorMessage = "Please select a Room Number.";
    } else if (!bookingDate) {
        errorMessage = "Please select a Booking Date.";
    } else if (!employeeId) {
        errorMessage = "Please select an Employee.";
    } else if (guest === "") {
        errorMessage = "Please enter the Guest name.";
    } else if (subject === "") {
        errorMessage = "Please enter a Meeting Subject.";
    } else if (selectedSlots.length === 0) {
        errorMessage = "Please select at least one Time Slot.";
    }

    // 4. Show error if validation fails
    if (errorMessage) {
        Swal.fire({
            title: "Validation Error",
            text: errorMessage,
            icon: "warning",
            confirmButtonColor: "#3085d6"
        });
        return; // Stop the function here
    }

    // 5. If everything is valid, ask for confirmation
    Swal.fire({
        title: "Confirm Booking",
        text: `Are you sure you want to book ${selectedSlots.length} slot(s) for this meeting?`,
        icon: "question",
        showCancelButton: true,
        confirmButtonColor: "#28a745",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, Book it!"
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById("bookingForm").submit();
        }
    });
}

/* ================================
   SLOT SELECTION
================================ */
document.querySelectorAll('.slot').forEach(slot => {
    slot.addEventListener('click', () => {

        if (slot.classList.contains('booked')) return;

        document.querySelectorAll('.slot').forEach(s => s.classList.remove('active'));
        slot.classList.add('active');

        selectedSlotTime = slot.dataset.time;
    });
});

/* ================================
   FILTER ROOMS BY TYPE
================================ */
function filterRoomsByType() {

	const typeId = document.getElementById("roomType").value;
    const roomNoSelect = document.getElementById("roomNo");

    // Clear Room No and Reset Slots
    roomNoSelect.innerHTML = '<option value="">Select Room No</option>';
    resetSlotStyles();

    if (!typeId) return;

    // Fetch Rooms for the selected Type
    fetch(`${contextPath}api/rooms-by-type?typeId=${typeId}`)
        .then(res => res.json())
        .then(rooms => {
            rooms.forEach(room => {
                const option = document.createElement("option");
                option.value = room.roomId;
                option.textContent = room.roomNo;
                roomNoSelect.appendChild(option);
            });

            // Automatically select the first room if available
            if (roomNoSelect.options.length > 1) {
                roomNoSelect.selectedIndex = 1;
                // Now load the slots for this auto-selected room
                loadBookedSlots();
            }
        })
        .catch(err => {
            console.error("Error loading rooms:", err);
            Swal.fire("Error", "Failed to load rooms", "error");
        });
}



function resetSlotStyles() {
    document.querySelectorAll('.slot').forEach(label => {
        label.classList.remove('booked-active');
        const cb = label.querySelector('input');
        if(cb) cb.disabled = false;
    });
}
/* ================================
   LOAD BOOKED SLOTS
================================ */

/* ================================
   SAFE EVENT LISTENER
================================ */
function addListener(selector, event, callback) {
    const el = document.querySelector(selector);
    if (el) el.addEventListener(event, callback);
}

/* ================================
   FORM RESET
================================ */
function resetForm() {

    document.getElementById("roomType").value = "";
    document.getElementById("roomNo").innerHTML = '<option value="">Select Room No</option>';
    document.querySelector('input[type="date"]').value = "";
    document.querySelector('input[placeholder="Enter guest name"]').value = "";
    document.querySelector('input[placeholder="Enter meeting subject"]').value = "";

    selectedSlotTime = null;

    document.querySelectorAll('.slot').forEach(slot => {
        slot.classList.remove('active', 'booked');
        slot.disabled = false;
    });
}

/* ================================
   TRIGGER ON ROOM / DATE CHANGE
================================ */
addListener('select[name="roomNo"]', 'change', loadBookedSlots);
addListener('input[type="date"]', 'change', loadBookedSlots);

/* ================================
   SIDEBAR MENU TOGGLE
================================ */
document.querySelectorAll('.menu-title').forEach(title => {
    title.addEventListener('click', function () {
        const parent = this.parentElement;

        parent.classList.toggle('open');

        document.querySelectorAll('.menu-item').forEach(item => {
            if (item !== parent) item.classList.remove('open');
        });
    });
});



function loadBookedSlots() {
    const roomId = document.getElementById("roomNo").value;
    const bookingDate = document.getElementById("bookingDate").value;

    if (!roomId || !bookingDate) return;

    fetch(`${contextPath}api/booked-slots?roomId=${roomId}&date=${bookingDate}`)
        .then(res => res.json())
        .then(bookedSlots => {
            const slotLabels = document.querySelectorAll('.slot');

            slotLabels.forEach(label => {
                const checkbox = label.querySelector('input');
                const timeValue = checkbox.value;

                // Reset state first
                label.classList.remove('booked-active');
                checkbox.disabled = false;

                // If slot is in the booked list from Java API
                if (bookedSlots.includes(timeValue)) {
                    label.classList.add('booked-active'); // This triggers RED CSS
                    checkbox.disabled = true;            // Prevent clicking
                    checkbox.checked = false;            // Uncheck if it was selected
                }
            });
        })
        .catch(err => console.error("Error checking slots:", err));
}

document.addEventListener("DOMContentLoaded", function() {
    const dateInput = document.getElementById("bookingDate");
    const roomTypeSelect = document.getElementById("roomType");
    const roomNoSelect = document.getElementById("roomNo");

   
    if (!dateInput.value) {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        dateInput.value = `${year}-${month}-${day}`;
    }


    if (roomTypeSelect.value) {
        const typeId = roomTypeSelect.value;

      
        roomNoSelect.innerHTML = '<option value="">Select Room No</option>';

        fetch(`${contextPath}api/rooms-by-type?typeId=${typeId}`)
            .then(res => res.json())
            .then(rooms => {
                rooms.forEach(room => {
                    const option = document.createElement("option");
                    option.value = room.roomId;
                    option.textContent = room.roomNo;
                    roomNoSelect.appendChild(option);
                });

            
                if (roomNoSelect.options.length > 1) {
                    roomNoSelect.selectedIndex = 1;
                    
                    loadBookedSlots(); 
                }
            })
            .catch(err => console.error("Error loading default rooms:", err));
    }
});
</script>



</html>


