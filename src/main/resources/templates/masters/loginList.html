<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Management</title>
    
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/sidebar.css}">
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/fontawesome/css/all.css}">
    <link rel="stylesheet" th:href="@{/fontfamily/css/google_font_family.css}">
    <link rel="stylesheet" th:href="@{/bootstrap/css/dataTables.bootstrap5.css}">
    <link rel="stylesheet" th:href="@{/bootstrap/css/bootstrap.min.css}">
    
    <script th:src="@{/js/script.js}" defer></script>
    <script th:src="@{/bootstrap/js/jquery-3.7.1.js}"></script>
    <script th:src="@{/bootstrap/js/dataTables.js}"></script>
    <script th:src="@{/bootstrap/js/dataTables.bootstrap5.js}"></script>
    <script th:src="@{/bootstrap/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/sweetalert/js/sweetalert2.all.min.js}"></script>
    
    <script th:inline="javascript">
        const contextPath = /*[[@{/}]]*/ '';
    </script>
    
    <style type="text/css">

.action-div{
	    padding: 12px;
	    margin: auto;
}

.action-div .btn-primary {
    margin: auto;
}

</style>
    
</head>
<body>

<div id="dashboardPage" class="page">
    <div class="dashboard-header">
            <div class="header-left">
                <div class="logo-mini">
                    <i class="fas fa-video"></i>
                    <span>VC Booking</span>
                </div>
                <h1>Welcome to Booking Page</h1>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <i class="fas fa-user-circle"></i>
                    <span id="loggedInUser">User</span>
                </div>
					              <a th:href="@{/login}" style="text-decoration: none;">
					    <button class="btn-logout" id="logoutBtn">
					        <i class="fas fa-sign-out-alt"></i> Logout
					    </button>
					</a>
            </div>
        </div>
        
        
        
	<div class="sidebar">
    <ol class="menu" style="list-style: none; padding: 0;">
        <li class="menu-item">
            <span class="menu-title">
                <i class="fas fa-database" style="margin-right: 10px;"></i> Master
            </span>
            <ol class="submenu">
                <li><a th:href="@{/login-list}">Login List</a></li>
                <li><a th:href="@{/employee/listrÌ¥}">Officer</a></li>
                <li><a th:href="@{/division/list}">Division</a></li>
                <li><a th:href="@{/Rooms}">Rooms</a></li>
            </ol>
        </li>

        <li class="menu-item">
            <span class="menu-title">
                <i class="fas fa-file-alt" style="margin-right: 10px;"></i> Reports
            </span>
            <ol class="submenu">
                <li><a th:href="@{/Booking-report}">Booking  Report</a></li>
                <li><a th:href="@{/Cancle-report}">Cancle Report</a></li>
            </ol>
        </li>
        
         <li class="menu-item">
            <span class="menu-title">
                <i class="fas fa-file-alt" style="margin-right: 10px;"></i> Booking
            </span>
            <ol class="submenu">
                <li><a th:href="@{/bookings}">Drona Booking</a></li>
                <li><a th:href="@{/Internet-Report}">Internet Report</a></li>
            </ol>
        </li>
    </ol>
</div>

      <!-- ============ CONTENT AREA ============ -->
       <div class="main-content">
	    <div class="page-header">
	        <h2><i class="fas fa-user-shield"></i> Login Management</h2>
	        <p>Manage System Access and User Roles</p>
	    </div>
	
	    <div class="glass-effect">
	        <h3>User Login List</h3>
	        <table class="table table-bordered" id="login-table">
	            <thead class="table-dark">
	                <tr>
	                    <th>S.No</th>
	                    <th>Username</th>
	                    <th>Employee Name</th>
	                    <th>Role</th>
	                    <th>Actions</th>
	                </tr>
	            </thead>
	            <tbody>
	                <tr th:each="user, iterStat : ${loginList}">
	                    <td th:text="${iterStat.count}">1</td>
	                    <td th:text="${user.userName}">admin</td>
	                    <td th:text="${user.empName}">-</td>
	                    <td th:text="${user.roleId}">ADMIN</td>
	                    <td class="text-center">
	                        <button class="btn btn-outline-primary btn-sm" th:onclick="editLogin([[${user}]])">
	                            <i class="fas fa-edit"></i>
	                        </button>
	                        <button class="btn btn-outline-danger btn-sm" th:onclick="confirmDeleteLogin([[${user.loginId}]])">
	                            <i class="fas fa-trash"></i>
	                        </button>
	                    </td>
	                </tr>
	            </tbody>
	        </table>
	
	        <button type="button" id="resetBtn" class="btn btn-secondary mt-3" onclick="resetForm()" style="display:none;">Add New User</button>
	        <hr>
	
	        <div class="action-div">
	            <form id="loginForm" th:action="@{/login/save}" th:object="${loginForm}" method="POST">
	                <input type="hidden" id="loginId" th:field="*{loginId}" />
	                <input type="hidden" id="formAction" name="formAction" value="add" />
	
	                <div class="row">
	                    <div class="col-md-4 form-group">
	                        <label>Username</label>
	                        <input type="text" id="userName" th:field="*{userName}" class="form-control" placeholder="Enter Username">
	                    </div>
	                    <div class="col-md-4 form-group">
	                        <label>Password</label>
	                        <input type="password" id="password" th:field="*{password}" class="form-control" placeholder="Enter Password">
	                    </div>
	                    <div class="col-md-4 form-group">
	                        <label>Employee</label>
	                        <select id="empId" th:field="*{empId}" class="form-control">
	                            <option value="">-- Select Employee --</option>
	                            <option th:each="emp : ${employeeList}" th:value="${emp.empId}" th:text="${emp.empName}"></option>
	                        </select>
	                    </div>
	                    <div class="col-md-4 form-group">
	                        <label>Role</label>
	                        <select id="roleId" th:field="*{roleId}" class="form-control">
	                            <option value="">-- Select Role --</option>
	                            <option value="ADMIN">ADMIN</option>
	                            <option value="USER">USER</option>
	                            <option value="APPROVER">APPROVER</option>
	                        </select>
	                    </div>
	                </div>
	                <button type="button" id="saveBtn" class="btn btn-primary mt-3" onclick="validateAndSubmit()">Add User</button>
	            </form>
	        </div>
	    </div>
	</div>
    
</div>

<script th:if="${successMessage}">Swal.fire("Success", "[[${successMessage}]]", "success");</script>
<script th:if="${errorMessage}">Swal.fire("Error", "[[${errorMessage}]]", "error");</script>

<script th:inline="javascript">
    function editLogin(data) {
        document.getElementById("loginId").value = data.loginId;
        document.getElementById("userName").value = data.userName;
        document.getElementById("userName").readOnly = true;
        document.getElementById("password").value = data.password;
        document.getElementById("empId").value = data.empId;
        document.getElementById("roleId").value = data.roleId;
        document.getElementById("formAction").value = "edit";
        document.getElementById("saveBtn").innerText = "Update User";
        document.getElementById("resetBtn").style.display = "block";
    }

    function resetForm() {
        location.reload();
    }

    function validateAndSubmit() {
        const fields = ["userName", "password", "empId", "roleId"];
        for(let f of fields) {
            if(!document.getElementById(f).value) {
                Swal.fire("Error", "All fields are required!", "warning");
                return;
            }
        }

        Swal.fire({
            title: "Are you sure?",
            text: "Do you want to save these user details?",
            icon: "question",
            showCancelButton: true,
            confirmButtonText: "Yes, Save"
        }).then((result) => {
            if (result.isConfirmed) document.getElementById("loginForm").submit();
        });
    }

    function confirmDeleteLogin(id) {
        Swal.fire({
            title: "Delete User?",
            text: "This user will no longer be able to login.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: '#d33'
        }).then((result) => {
            if (result.isConfirmed) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = contextPath + "login/delete/" + id;
                const csrf = document.querySelector('meta[name="_csrf"]').content;
                const input = document.createElement('input');
                input.type = 'hidden'; input.name = '_csrf'; input.value = csrf;
                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
        });
    }

    $(document).ready(function() {
        $('#login-table').DataTable({
            "language": {
                "emptyTable": "No divisions found in the system"
            }
        });
    });
</script>

</body>
</html>